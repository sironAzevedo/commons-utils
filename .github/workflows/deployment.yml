name: commons-utils

on:
  push:
    branches: [ main ]

jobs:
    increment-version:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: 17
        - name: Increment version
          id: increment_version
          run: |
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
            NEW_VERSION=$(echo $VERSION | sed -E 's/([0-9]+)\.([0-9]+)-SNAPSHOT/\1.\2+1/')
            mvn versions:set -DnewVersion=$NEW_VERSION
            sed -i 's/<version>.*<\/version>/<version>'$NEW_VERSION'<\/version>/' pom.xml
            git config --global user.name 'github-actions[bot]'
            git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
            git add pom.xml
            git commit -m "Increment version to $NEW_VERSION"
            git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/sironAzevedo/commons-utils.git HEAD:main

    compile:
        runs-on: ubuntu-latest
        needs: increment-version
        steps:
        - uses: actions/checkout@v4
        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: 17
        - name: Cache Maven dependencies
          uses: actions/cache@v3
          with:
            path: ~/.m2/repository
            key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
            restore-keys: |
              ${{ runner.os }}-maven-
        - name: build & Compile project
          run: mvn clean compile install -DskipTests

    test:
        runs-on: ubuntu-latest
        name: Running tests
        needs: compile
        steps:
          - uses: actions/checkout@v4
          - name: Set up JDK 17
            uses: actions/setup-java@v4
            with:
              distribution: 'temurin'
              java-version: 17
          - name: Cache Maven dependencies
            uses: actions/cache@v3
            with:
              path: ~/.m2/repository
              key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
              restore-keys: |
                ${{ runner.os }}-maven-
          - name: Run unit tests
            run: mvn test

    publish:
      runs-on: ubuntu-latest
      needs: test
      permissions:
        contents: read
        packages: write
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-java@v4
          with:
            java-version: '11'
            distribution: 'temurin'
        - name: Cache Maven dependencies
          uses: actions/cache@v3
          with:
            path: ~/.m2/repository
            key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
            restore-keys: |
              ${{ runner.os }}-maven-
        - name: Publish package
          run: mvn --batch-mode deploy
          env:
            GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}